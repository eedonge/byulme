<!DOCTYPE html>
<html>
<head>

<!--META-->
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>별미 로그인</title>

<!--STYLESHEETS-->
<link type="text/css" rel="stylesheet" href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" />
<link href="style/login.css" rel="stylesheet" type="text/css" />
<!--SCRIPTS-->
<script type="text/javascript" src="lib/jquery-2.0.3.min.js"></script>
<script type="text/javascript" src="lib/jquery.cookie.js"></script>
<!--Slider-in icons-->
<script type="text/javascript">

//Log In Check
if($.cookie('bm_uid')){
	document.location.href = "/byulme";
}

$(document).ready(function() {

	$(".username").focus(function() {
		$(".user-icon").css("left","-48px");
	});
	$(".username").blur(function() {
		$(".user-icon").css("left","0px");
	});
	
	$(".password").focus(function() {
		$(".pass-icon").css("left","-48px");
	});
	$(".password").blur(function() {
		$(".pass-icon").css("left","0px");
	});

	var showErrMsg = function(targetId, errMsg){
		$target = $('#' + targetId);
		$target.focus();
		var option={
			title : errMsg,
			trigger : 'manual',
			placement:'top'
		}; 
		$target.tooltip(option);
		$target.tooltip('show');

		setTimeout(function(){
			$target.tooltip('destroy')
		 }, 5000);
	};

	var validForm = function(type){
		var pEmail = $("#username" ).val();
		var pPass = $("#password" ).val();
		var pRePass = $("#re_password" ).val();

		if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(pEmail) === false)  
		{  
		  showErrMsg('username', '이메일을 정확하게 입력하세요!');
		  	return false;
		}else if(pPass.length < 5){
		  showErrMsg('password', '비밀번호는 최소 5자 이상입니다!');
		  	return false;
		}else if(type === 'REGISTER' && pPass !== pRePass){
		  showErrMsg('re_password', '비밀번호가 일치하지 않습니다.');
		  	return false;
		}else{
			return true;
		}
	};


	var initFormUI = function(type){
		var enTargetID,
		    disTargetID;

		if(type==="LOGIN"){

			$("input[name='re_password']" ).hide();
			enTargetID = "sm_login";
			disTargetID = "sm_register";

			$('.header > h1').text('로그인');
			$('.header > span').text('이메일, 비밀번호를 입력해 주세요');

		}else if(type==="REGISTER"){

			$("input[name='re_password']" ).show();
			enTargetID = "sm_register";
			disTargetID = "sm_login";

			$('.header > h1').text('회원가입');
			$('.header > span').text('이메일, 비밀번호, 비밀번호확인 입력해 주세요');
		}

		
		$('#' + enTargetID).removeClass('n_button');
		$('#' + enTargetID).addClass('a_button');

		$('#' + disTargetID).removeClass('a_button');
		$('#' + disTargetID).addClass('n_button');
	};

	var resultBox = function(msg){
		$("#login_complete_box").hide();
		$("#login_complete_box > strong").text(msg);
		$("#login_complete_box").toggle( "bounce", { times: 3 }, "slow" );
	}

	$("#sm_login").click(function(){
		if($(this).hasClass('n_button')){
			initFormUI('LOGIN');
		}else if(validForm('LOGIN')){
			//Log In Request
			$.ajax({
				type:"POST",
				url:"/bm/sign/LOGIN",
				data:{
				  email: $("#username" ).val(),
				  pass:  CryptoJS.MD5($("#password" ).val()).toString()
				}
			}).done(function(data){
				if(data.length <= 0){
					resultBox('등록된 사용자가 없습니다');
					$('#username').focus();
				}else{
					require(["script/util/bm"], function(bm) {
						bm.login(data[0].uid, data[0].type);
						document.location.href = "/byulme";
					});
				}
			}).fail(function(data){});
		}
	});

	$("#sm_register").click(function(){
		if($(this).hasClass('n_button')){
			initFormUI('REGISTER');
		}else if(validForm('REGISTER')){
			//Register Request
			$.ajax({
				type:"POST",
				url:"/bm/sign/SIGNIN",
				data:{
				  email: $("#username" ).val(), 
				  pass:  CryptoJS.MD5($("#password" ).val()).toString()
				}
			}).done(function(data){
				if(data.affectedRows == 1){
				  resultBox('정상 등록되었습니다. 이메일을 확인해주세요!');
				}else if(data.code == "ER_DUP_ENTRY"){
				  resultBox('이미 등록된 사용자 입니다!');
				}
			}).fail(function(data){});	
		}
	});

});

</script>

</head>
<body>

<!--WRAPPER-->
<div id="wrapper">

	<!--SLIDE-IN ICONS-->
    <div class="user-icon"></div>
    <div class="pass-icon"></div>
    <!--END SLIDE-IN ICONS-->

<!--LOGIN FORM-->
<!--<form name="login-form" class="login-form" action="" method="post">-->
	<div name="login-form" class="login-form">

	<!--HEADER-->
    <div class="header">
    <!--TITLE--><h1>로그인</h1><!--END TITLE-->

    <!--DESCRIPTION-->	
    <span>이메일, 비밀번호를 입력해 주세요</span>
    <!--END DESCRIPTION-->
    </div>
    <!--END HEADER-->
	
	<!--CONTENT-->
    <div class="content">
	<!--USERNAME--><input id="username" name="username" type="text" class="input username" placeholder="이메일" /><!--END USERNAME-->
    <!--PASSWORD--><input id="password" name="password" type="password" class="input password" placeholder="비밀번호" /><!--END PASSWORD-->
    <!--PASSWORD--><input id="re_password" name="re_password" type="password" class="input password" style="display:none;" placeholder="비밀번호 확인" /><!--END PASSWORD-->
    </div>
    <!--END CONTENT-->
    
    <!--FOOTER-->
    <div class="footer">
    <!--LOGIN BUTTON--><input id="sm_login" type="submit" name="submit" value="로그인" class="a_button" /><!--END LOGIN BUTTON-->
    <!--REGISTER BUTTON--><input id="sm_register" type="submit" name="submit" value="회원가입"  class="n_button" /><!--END REGISTER BUTTON-->
    </div>
    <!--END FOOTER-->
	</div>
<!--</form>-->
<!--END LOGIN FORM-->

</div>
<!--END WRAPPER-->
<div id="login_complete_box" class="alert alert-success login_complete_box">
	<a class="close" data-dismiss="alert" href="#" aria-hidden="true">&times;</a>
	<strong>테스트 [ ID : startup@starme.com,  PW : 11111 ]</strong>
</div>

<!--GRADIENT--><div class="gradient"></div><!--END GRADIENT-->

</body>
<script type="text/javascript" src="script/util/jquery-ui.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script>
<script type="text/javascript" src="cornerstone/lib/require.js"></script>
<script type="text/javascript" src="script/util/md5.js"></script>
</html>